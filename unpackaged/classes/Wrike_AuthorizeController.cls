public with sharing class Wrike_AuthorizeController {
 
 	private static final String DEFAULT_SETTINGS_INTSTANCE = 'Active';
 	
    public Wrike_AuthorizeController() {
    	settings = WrikeAccountSettings__c.getInstance();
    }
    
    private WrikeAccountSettings__c settings;

    private final static String WRIKE_OAUTH2_AUTHORIZE =
        Wrike_AbstractSectionController.WRIKE_DOMAIN + '/oauth2/authorize?response_type=code';

    private final static String WRIKE_OAUTH2_TOKEN =
        Wrike_AbstractSectionController.WRIKE_DOMAIN + '/oauth2/token';

    /*
    private final static String CLIENT_ID = 'xxxxxxx';
    private final static String CLIENT_SECRET = 'xxxxxxx';
    */
   
    private String getRedirectURI() {

        return EncodingUtil.urlEncode(
                    URL.getSalesforceBaseUrl().toExternalForm() + '/apex/Wrike_Authorize?return_path='
                    + ApexPages.currentPage().getParameters().get('return_path'),
                'UTF-8');
    }

    public PageReference authorize() {
    	
    	System.debug('ApexPages.currentPage().getParameters() ' + ApexPages.currentPage().getParameters());

        if (!ApexPages.currentPage().getParameters().containsKey('return_path'))
            return null;

		if(ApexPages.currentPage().getParameters().containsKey('error')) {
         
            PageReference test = new PageReference(
                    URL.getSalesforceBaseUrl().toExternalForm() +
                    ApexPages.currentPage().getParameters().get('return_path'));
            test.setRedirect(true);
            return test;
		}

        if(ApexPages.currentPage().getParameters().containsKey('code')) {
            // Redirected from Wrike.com

            Http http = new Http();
            HttpRequest req = new HttpRequest();
        
            req.setEndpoint(WRIKE_OAUTH2_TOKEN);
            req.setMethod('POST');
        
            req.setBody('client_id=' + settings.wrikeClientId__c +
                '&client_secret=' + settings.wrikeClientSecret__c +
                '&grant_type=authorization_code' +
                '&redirect_uri=' + getRedirectURI() +
                '&code=' + ApexPages.currentPage().getParameters().get('code'));
        
            HttpResponse res = http.send(req);
            String body = res.getBody();
            if (body == null) return null;
            
            String token, refreshToken;

            JSONParser parser = JSON.createParser(res.getBody());
            while (parser.nextToken() != null) {
                if(parser.getCurrentToken() == JSONToken.FIELD_NAME) {
                    if(parser.getText() == 'access_token') {
                        parser.nextToken();
                        token = parser.getText();
                    }
                    else if (parser.getText() == 'refresh_token') {
                        parser.nextToken();
                        refreshToken = parser.getText();
                    }
                }
            }

            if (token != null) {
                
                // Check state and save tokens to Custom Settings
                // User Permissions Needed:
                // To manage, create, edit, and delete custom settings: 'Customize Application'

                Wrike_API__c api = Wrike_API__c.getInstance();
                if (api.State__c == ApexPages.currentPage().getParameters().get('state')) {
                    api.Token__c = token;
                    api.RefreshToken__c = refreshToken;
                    api.State__c = '';
                    upsert api;
                }
            }
        
            PageReference test = new PageReference(
                    URL.getSalesforceBaseUrl().toExternalForm() +
                    ApexPages.currentPage().getParameters().get('return_path'));
            test.setRedirect(true);
            return test;
        }
        else {

            // Create state and save in Custom Settings
            // User Permissions Needed:
            // To manage, create, edit, and delete custom settings: 'Customize Application'

            Wrike_API__c api = Wrike_API__c.getInstance();
            api.State__c = EncodingUtil.convertToHex(crypto.generateAesKey(128))
                .substring(0,16).toUpperCase();

            upsert api;

            String wrikeTarget = WRIKE_OAUTH2_AUTHORIZE;
            wrikeTarget += '&client_id=' + settings.wrikeClientId__c;
            wrikeTarget += '&state=' + api.State__c;
            wrikeTarget += '&redirect_uri=' + getRedirectURI();
            System.debug('wrikeTarget ' + wrikeTarget);
            System.debug('api.State__c ' + api.State__c);

            PageReference wrikeAuthorize = new PageReference(wrikeTarget);
            wrikeAuthorize.setRedirect(true);
            return wrikeAuthorize;
        }
        return null;
   }
   
   public static void validate_AuthorizeController() {
        Integer i = 0;
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
    }
}